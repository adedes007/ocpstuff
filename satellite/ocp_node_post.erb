<%#
name: ocp_node_post
snippet: false
model: JobTemplate
job_category: Miscellaneous
provider_type: Ansible
kind: job_template
organizations:
- nicknach
locations:
- home
%>

---
- hosts: all
  tasks:
    - shell: |
        cp /etc/origin/node/pods/apiserver.yaml apiserver.yaml.prepatch
        oc ex config patch apiserver.yaml.prepatch -p '{"spec":{"containers":[{"name":"api","volumeMounts":[{"mountPath":"/etc/pki","name":"certs"}]}],"volumes":[{"hostPath":{"path":"/etc/pki","type":"Directory"},"name":"certs"}]}}' > /etc/origin/node/pods/apiserver.yaml 
        wget https://raw.githubusercontent.com/Maistra/openshift-ansible/maistra-0.4/istio/master-config.patch
        cp -p /etc/origin/master/master-config.yaml master-config.yaml.prepatch
        oc ex config patch master-config.yaml.prepatch -p "$(cat master-config.patch)" > /etc/origin/master/master-config.yaml
        /usr/local/bin/master-restart api && /usr/local/bin/master-restart controllers
        echo 'vm.max_map_count = 262144' > /etc/sysctl.d/99-elasticsearch.conf
        yum -y -d1 install kernel-devel
        rpm -ivh https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm
        #rpm -ivh https://developer.download.nvidia.com/compute/cuda/repos/rhel7/x86_64/cuda-repo-rhel7-9.1.85-1.x86_64.rpm 
        yum -y -d1 install xorg-x11-drv-nvidia xorg-x11-drv-nvidia-devel
        yum -y -d1 install cuda-9-1
        curl -s -L https://nvidia.github.io/nvidia-container-runtime/centos7/x86_64/nvidia-container-runtime.repo | tee /etc/yum.repos.d/nvidia-container-runtime.repo
        yum -y -d1 install nvidia-container-runtime-hook
        curl http://satellite.home.nicknach.net/pub/oci-nvidia-hook > /usr/libexec/oci/hooks.d/oci-nvidia-hook
        chmod +x /usr/libexec/oci/hooks.d/oci-nvidia-hook
        chcon -R -t container_file_t  /dev/nvidia*
        restorecon -R /dev/nvidia*
        setenforce 0 && sed -i 's/=enforcing/=permissive/' /etc/selinux/config
        grub2-mkconfig -o /boot/grub2/grub.cfg
      register: out
    - debug: var=out
